---
title: "Intro to survey and srvyr package and numeric data analysis in tidy R"
author: "Luis E Segura"
date: "2023-05-19"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
```

### Step 1: Load Packages and Dataset
We will be using four packages in this session. 

The package tidyverse is a collection of packages designed for data science. All packages included in tidyverse share an underlying coding grammar often called tidy. You can learn more about coding using tidy language in the book R for Data Science by Hadley Wickham. An online version can be found here: https://r4ds.hadley.nz

The package survey is an R package that provides functions to analyze data from complex surveys. Documentation for this package can be found here: https://r-survey.r-forge.r-project.org/survey/

The package srvyr allows to use tidy coding language using functions from the package survey. You can read more about this here: http://gdfe.co/srvyr/ 

We are going to use the dataset called NHANESraw that comes with the NHANES package. 

The NHANES is survey data collected by the US National Center for Health Statistics (NCHS) which has conducted a series of health and nutrition surveys since the early 1960â€™s. Since 1999 approximately 5,000 individuals of all ages are interviewed in their homes every year and complete the health examination component of the survey. The NHANES target population is "the non-institutionalized civilian resident population of the United States". The NHANES (National Health and Nutrition Examination surveys) use complex survey designs (see http://www.cdc.gov/nchs/data/series/sr_02/sr02_162.pdf) that oversample certain subpopulations like racial minorities. Naive analysis of the NHANES data can lead to mistaken conclusions. 
The NHANESraw include 75 variables available for the 2009-2010 and 2011-2012 sample years. NHANESraw has 20,293 observations of these variables plus four additional variables that describe that sample weighting scheme employed.

```{r load packages and data, echo = T}
### Load libraries needed
library(tidyverse)
library(survey)
library(srvyr)
library(NHANES)

### Load data
data("NHANESraw")
```

### Step 2: Data pre processing
We use the function glimpse() to explore the whole dataset. 

```{r data, echo = T}
### Explore the whole dataset
glimpse(NHANESraw)

```

R is case sensitive. So, one of the things I recommend is to transform all variable names to lower caps. This will prevent R throwing errors because you mistyped a variable name.

```{r low caps, echo = T}
### transform variable names to lower caps
NHANESraw <- NHANESraw |>
  rename_all(.funs = tolower)

### print variable names
NHANESraw |>
  names()

```

The weights in the NHANES (wtmec2yr) were constructed assuming you have 2 years of data. However, we have 4 years of data. So, we are going to modify the weights by dividing them by 2.

```{r weights, echo = T}
NHANESraw <- NHANESraw |> 
  mutate(new_wt = wtmec2yr / 2)

```

### Step 3: Creating a survey design object 

Once your dataset is loaded and all variables you need are clean and recoded create a survey design object

The survey design tells R what sampling design generated the data.
The survey design object for a complex sample has the following information:
- the data
- weights (we are using the new weights we created above) 
- strata
- sample stages information

The NHANES has 4 sampling stages. However, we only need to declare the first clustering stage (sdmvpsu).

```{r survey design, echo = T}
nhanes_design <- NHANESraw |> 
  as_survey_design(strata = sdmvstra, 
                   id = sdmvpsu, 
                   weights = new_wt, 
                   nest = T)

nhanes_design

```

### Step 4: Exploring Numeric Data

#### Summarizing a continous variable 

For this example, we are going to use alcohol consumption per day as our outcome of interest. Alcohol consumption per day is a numeric variable. We call the function class() function to see if this is a numeric variable.
```{r class, echo = T}
class(NHANESraw$alcoholday)
```

We do a bit of exploration of this variable before estimating survey weighted summary statistics. Note there are missing values and extreme values. One package that I find very useful for quick summary statistics is skimr 
```{r explore, echo = T}
### We can use base R functions to get quick summaries. Note there are missing values (NA's)
summary(NHANESraw$alcoholday) 

### using the function skim from the package skimr
library(skimr)

NHANESraw |> 
  skim(alcoholday)
```

Plot a histogram to see the variable distribution
```{r hist, echo = T}
NHANESraw |>
  ggplot(aes(x = alcoholday)) +
  geom_histogram() + 
  theme_classic()

```

### Step 5: Estimate survey weighted summary statistics
Estimate the survey weighted mean, median, quantiles
```{r svy mean, echo = T}
### add the argument na.rm = TRUE to survey functions to ignore the missing values.
nhanes_design |>
  ### request confidence intervals with option vartype = "ci"
  summarise(mean = survey_mean(alcoholday, na.rm = T, vartype = "ci"), 
            median = survey_median(alcoholday, na.rm = T, vartype = "ci"), 
            quantile = survey_quantile(alcoholday, c(0.25, 0.75), na.rm = T, vartype = "ci")) |>
  ### pivot the table to long
  pivot_longer(everything(), names_to = "statistics", values_to = "value") 

```

#### Summarizing by groups
Lets estimate the average alcohol consumption per day by race group and, separately, by gender
```{r by grps, echo = T}
nhanes_design |>
  group_by(race1) |>
  summarise(mean = survey_mean(alcoholday, na.rm = T, vartype = "ci"))

alc_sex <- nhanes_design |>
  group_by(gender) |>
  summarise(mean = survey_mean(alcoholday, na.rm = T, vartype = "ci"))

alc_sex
```

We can also use a bar graph to visualise these differences
```{r graph, echo = T}
alc_sex |>
  ggplot(aes(x = gender, y = mean, 
             ### specify the lower and upper limit of confidence intervals to plot the error bars
             ymin = mean_low, ymax = mean_upp)) +
  geom_col(fill = "lightblue") +
  ### add CI error bars
  geom_errorbar(width = 0.4) +
  ylab("Average alcohol per day consumption") +
  xlab("Gender") + 
  theme_classic()

```

#### Hypothesis testing
Test the difference in mean alcohol consumption by gender.
```{r ttest, echo = T}
svyttest(alcoholday ~ gender, design = nhanes_design) 

```

Estimate the average consumption of alcoholic drinks per day by age
```{r alc age, echo = T}
alc_age <- nhanes_design |>
  group_by(age) |>
  summarise(mean = survey_mean(alcoholday, na.rm = T, vartype = "ci")) 

alc_age |>
  ggplot(aes(x = age, y = mean)) + 
  geom_line() + 
  geom_point() + 
  theme_classic()

```

Notice that individuals less than 18 have zero alcohol consumption. 

So, we are going to exclude these individuals from our analysis.

Lets look at the trend in alcohol consumption per day by age among those aged 18 and older. We are going to add a linear trend line to our graph.
```{r alc age 18, echo = T}
alc_age %>%
  ### filter to those 18 and older
  filter(age > 17) %>%
  ggplot(aes(x = age, y = mean)) + 
  geom_line() + 
  ### Remove confidence interval
  geom_smooth(method = "lm", se = FALSE) + 
  ylab("Average consumption of alcohol per day") + 
  xlab("Age in years") + 
  theme_classic()

alc_age %>%
  filter(age > 17) %>%
  ggplot(aes(x = age, y = mean)) +
  geom_point() +
  ### add confidence interval
  geom_smooth(method = "lm") +
  ylab("Average consumption of alcohol per day") + 
  xlab("Age in years") + 
  theme_classic()
```

Add a smooth line instead of a linear trend line
```{r smooth, echo = T}
alc_age %>%
  filter(age > 17) %>%
  ggplot(aes(x = age, y = mean)) +
  geom_point() +
  ### add smooth line
  geom_smooth(method = "loess") +
  ylab("Average consumption of alcohol per day") + 
  xlab("Age in years") + 
  theme_classic()
```

Estimate the average consumption of alcoholic drinks per day by both age and gender among adults (18 and older)
```{r alc age * gender, echo = T}
alc_age_male <- nhanes_design |>
  filter(age > 17) |>
  group_by(gender, age) |>
  summarise(mean = survey_mean(alcoholday, na.rm = T, vartype = "ci"))

alc_age_male |>
  ggplot(aes(x = age, y = mean, color = gender)) + 
  geom_point() +
  geom_line() + 
  ylab("Average alcohol consumption per day") +
  theme_classic()
```


#### Modeling continuous data 
Run a simple linear regression using survey weighted data to model the daily consumption of alcoholic beverages with age as an explanatory variable. 
We are going to load another package called broom and use the function tidy() to tidy our model regression output,
```{r linear, echo = T}
library(broom)

svyglm(alcoholday ~ age, design = nhanes_design, family = gaussian) |>
  tidy(conf.int = T)
```

Add more independent variables (gender) to the logistic regression model to run a multivariable logistic regression
```{r multi linear, echo = T}
svyglm(alcoholday ~ age + gender, design = nhanes_design, family = gaussian) |>
  tidy(conf.int = T)

```

